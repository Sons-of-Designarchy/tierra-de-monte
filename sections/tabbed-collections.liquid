<section id="tabbed-collections-{{ section.id }}" class="page-width">
  {% if section.settings.kicker != blank %}
    <p class="caption-with-letter-spacing">{{ section.settings.kicker }}</p>
  {% endif %}
  {% if section.settings.heading != blank %}
    <h2 class="h1">{{ section.settings.heading }}</h2>
  {% endif %}
  {% if section.settings.subheading != blank %}
    <p class="subtitle">{{ section.settings.subheading }}</p>
  {% endif %}

  {%- assign has_any = false -%}
  {%- for i in (1..6) -%}
    {%- capture key %}collection_{{ i }}{% endcapture -%}
    {%- assign c = section.settings[key] -%}
    {%- if c != blank -%}{%- assign has_any = true -%}{%- endif -%}
  {%- endfor -%}

  {% if has_any %}
    <div class="tabs">
      <div class="tabs__list" role="tablist">
        {%- assign first_rendered = true -%}
        {%- for i in (1..6) -%}
          {%- capture ckey %}collection_{{ i }}{% endcapture -%}
          {%- capture lkey %}label_{{ i }}{% endcapture -%}
          {%- capture dkey %}dot_{{ i }}{% endcapture -%}
          {%- capture ikey %}icon_{{ i }}{% endcapture -%}
          {%- assign c = section.settings[ckey] -%}
          {%- if c != blank -%}
            {%- assign label = section.settings[lkey] | default: c.title -%}
            {%- assign icon = section.settings[ikey] -%}
            <button
              class="tabs__tab{% if first_rendered %} is-active{% endif %}"
              type="button"
              role="tab"
              aria-selected="{% if first_rendered %}true{% else %}false{% endif %}"
              data-target="tc-panel-{{ section.id }}-{{ i }}"
            >
              {%- if icon != blank -%}
                {{ icon | image_url: width: 28 | image_tag: class: 'tabs__icon-img', alt: '' }}
              {%- elsif section.settings[dkey] -%}
                <span class="tabs__dot"></span>
              {%- endif -%}
              <span class="tabs__label">{{ label }}</span>
            </button>
            {%- assign first_rendered = false -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>

    <div class="tabs__panels">
      {%- assign first_panel = true -%}
      {%- for i in (1..6) -%}
        {%- capture ckey %}collection_{{ i }}{% endcapture -%}
        {%- assign c = section.settings[ckey] -%}
        {%- if c != blank -%}
          <div
            id="tc-panel-{{ section.id }}-{{ i }}"
            class="tabs__panel{% unless first_panel %} is-hidden{% endunless %}"
            role="tabpanel"
          >
            {% liquid
              assign prod_limit = section.settings.products_limit | plus: 0
            %}
            <div class="grid grid--2-col-tablet grid--4-col-desktop">
              {% for product in c.products limit: prod_limit %}
                <div class="grid__item">
                  {% render 'card-product', card_product: product %}
                </div>
              {% endfor %}
            </div>

            {% if section.settings.show_view_all and c.url %}
              <div class="center" style="margin-top:1rem;">
                <a href="{{ c.url }}" class="button tc__cta">
                  {{ section.settings.view_all_label | default: 'Ver más productos' }}
                </a>
              </div>
            {% endif %}
          </div>

          {%- assign first_panel = false -%}
        {%- endif -%}
      {%- endfor -%}
    </div>
  {% else %}
    <p style="opacity:.7">Set “Collection 1…6” in the section settings.</p>
  {% endif %}
</section>

<style>
    /* Section spacing */
    #tabbed-collections-{{ section.id }} {
      --tc-border: rgba(var(--color-foreground), .25);
      --tc-active-bg: #dfeadf;
      --tc-dot: #2fb673;
      --tc-gap: 12px;
      padding-top: 80px;
      padding-bottom: 80px;
    }

    /* Headings + subtitle centered */
    #tabbed-collections-{{ section.id }} .caption-with-letter-spacing,
    #tabbed-collections-{{ section.id }} .h1,
    #tabbed-collections-{{ section.id }} .subtitle {
      text-align: center;
      margin-left: auto;
      margin-right: auto;
    }
    #tabbed-collections-{{ section.id }} .h1 { margin: .25rem 0 .5rem; }
    #tabbed-collections-{{ section.id }} .subtitle { margin: .25rem 0 1.25rem; opacity: .9; }

    /* ===== Tabs row: full-width responsive grid ===== */
    #tabbed-collections-{{ section.id }} .tabs__list{
      display: grid !important;                /* kill old flex rules */
      width: 100%;
      gap: var(--tc-gap);
      margin: .5rem 0 1.25rem;
      grid-template-columns: repeat(2, minmax(0, 1fr));     /* mobile */
    }
    @media (min-width: 750px){
      #tabbed-collections-{{ section.id }} .tabs__list{
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    @media (min-width: 990px){
      #tabbed-collections-{{ section.id }} .tabs__list{
        grid-template-columns: repeat(6, minmax(0, 1fr));   /* 6 tabs across */
      }
    }

    /* Pill buttons */
    #tabbed-collections-{{ section.id }} .tabs__tab{
      width: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .55rem;
      border: 1px solid var(--tc-border);
      border-radius: 4px;
      background: #f7f3ee;
      padding: .65rem .95rem;
      line-height: 1;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    #tabbed-collections-{{ section.id }} .tabs__tab:hover{
      background: rgba(var(--color-foreground), .05);
    }
    #tabbed-collections-{{ section.id }} .tabs__tab.is-active{
      background: #E4E7C3;
      border-color: #E4E7C3;
      color: #1F4D37;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.06);
    }

    /* Icon / dot */
    #tabbed-collections-{{ section.id }} .tabs__icon-img{ width:18px; height:18px; object-fit:contain; flex:0 0 auto; }
    #tabbed-collections-{{ section.id }} .tabs__label{ white-space:nowrap; }
    #tabbed-collections-{{ section.id }} .tabs__dot{ width:.9rem; height:.9rem; border-radius:50%; background: var(--tc-dot); flex:0 0 auto; }

    /* Panels */
    #tabbed-collections-{{ section.id }} .tabs__panel.is-hidden{ display:none !important; }

    /* Product grid + CTA */
    #tabbed-collections-{{ section.id }} .grid__item { margin-bottom: 1.25rem; }
    #tabbed-collections-{{ section.id }} .center { text-align: center; }
    #tabbed-collections-{{ section.id }} .tc__cta{ border-radius: 999px; padding: .6rem 1.1rem; }
    #tabbed-collections-{{ section.id }} .badge { border-radius: 999px; }


    /* === Fix long labels + fill full width === */

  /* Make the row auto-fit without empty space on the right */
  #tabbed-collections-{{ section.id }} .tabs__list{
    display: grid !important;
    width: 100%;
    gap: 12px;
    /* auto-fit packs as many columns as fit; remaining space is redistributed so no right gap */
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }

  /* Optional: on very wide screens, allow slightly wider cells */
  @media (min-width: 1200px){
    #tabbed-collections-{{ section.id }} .tabs__list{
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
  }

  /* Buttons: allow content to wrap inside the cell */
  #tabbed-collections-{{ section.id }} .tabs__tab{
    width: 100%;
    min-height: 35px;
    min-width: 0;              /* allow children to shrink */
    padding: .7rem 1rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: .55rem;
    text-align: center;
  }

  /* Label: wrap + break long words if needed */
  #tabbed-collections-{{ section.id }} .tabs__label{
    white-space: normal;        /* was nowrap */
    overflow-wrap: anywhere;    /* break very long words */
    word-break: break-word;
    line-height: 1.2;
    min-width: 0;               /* avoid overflow in flex */
  }

  /* Keep icons tidy */
  #tabbed-collections-{{ section.id }} .tabs__icon-img{ width: 18px; height: 18px; flex: 0 0 auto; }
</style>

{% schema %}
{
  "name": "Tabbed collections",
  "settings": [
    { "type": "text", "id": "kicker", "label": "Kicker" },
    { "type": "text", "id": "heading", "label": "Heading" },
    { "type": "text", "id": "subheading", "label": "Subheading" },

    { "type": "collection", "id": "collection_1", "label": "Collection 1" },
    { "type": "text", "id": "label_1", "label": "Label 1" },
    { "type": "checkbox", "id": "dot_1", "label": "Show dot 1", "default": true },
    { "type": "image_picker", "id": "icon_1", "label": "Icon 1 (SVG/PNG)" },

    { "type": "collection", "id": "collection_2", "label": "Collection 2" },
    { "type": "text", "id": "label_2", "label": "Label 2" },
    { "type": "checkbox", "id": "dot_2", "label": "Show dot 2", "default": true },
    { "type": "image_picker", "id": "icon_2", "label": "Icon 2 (SVG/PNG)" },

    { "type": "collection", "id": "collection_3", "label": "Collection 3" },
    { "type": "text", "id": "label_3", "label": "Label 3" },
    { "type": "checkbox", "id": "dot_3", "label": "Show dot 3", "default": true },
    { "type": "image_picker", "id": "icon_3", "label": "Icon 3 (SVG/PNG)" },

    { "type": "collection", "id": "collection_4", "label": "Collection 4" },
    { "type": "text", "id": "label_4", "label": "Label 4" },
    { "type": "checkbox", "id": "dot_4", "label": "Show dot 4", "default": true },
    { "type": "image_picker", "id": "icon_4", "label": "Icon 4 (SVG/PNG)" },

    { "type": "collection", "id": "collection_5", "label": "Collection 5" },
    { "type": "text", "id": "label_5", "label": "Label 5" },
    { "type": "checkbox", "id": "dot_5", "label": "Show dot 5", "default": true },
    { "type": "image_picker", "id": "icon_5", "label": "Icon 5 (SVG/PNG)" },

    { "type": "collection", "id": "collection_6", "label": "Collection 6" },
    { "type": "text", "id": "label_6", "label": "Label 6" },
    { "type": "checkbox", "id": "dot_6", "label": "Show dot 6", "default": true },
    { "type": "image_picker", "id": "icon_6", "label": "Icon 6 (SVG/PNG)" },

    {
      "type": "select",
      "id": "products_limit",
      "label": "Products per tab",
      "default": "4",
      "options": [
        { "label": "4", "value": "4" },
        { "label": "8", "value": "8" },
        { "label": "12", "value": "12" }
      ]
    },
    { "type": "checkbox", "id": "show_view_all", "label": "Show “View more” button", "default": true },
    { "type": "text", "id": "view_all_label", "label": "Button label", "default": "Ver más productos" }
  ],
  "presets": [{ "name": "Tabbed collections" }]
}
{% endschema %}

<script>
  document.addEventListener('click', function (e) {
    var root = document.getElementById('tabbed-collections-{{ section.id }}');
    if (!root) return;

    var btn = e.target.closest('#tabbed-collections-{{ section.id }} .tabs__tab');
    if (!btn || !root.contains(btn)) return;

    root.querySelectorAll('.tabs__tab').forEach(function (t) {
      var active = t === btn;
      t.classList.toggle('is-active', active);
      t.setAttribute('aria-selected', active ? 'true' : 'false');
    });

    root.querySelectorAll('.tabs__panel').forEach(function (p) {
      p.classList.add('is-hidden');
    });

    var panelId = btn.getAttribute('data-target');
    if (!panelId) return;
    var panel = root.querySelector('#' + panelId);
    if (panel) panel.classList.remove('is-hidden');
  });
</script>
