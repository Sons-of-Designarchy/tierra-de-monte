{% liquid
  assign sid = section.id
  assign picks = ''
  for i in (1..6)
    assign h = section.settings["collection_" | append: i]
    if h != blank
      assign picks = picks | append: h | append: ','
    endif
  endfor
  assign handles = picks | split: ',' | reject: ''
%}

<section id="tabbed-collections-{{ sid }}" class="page-width">
  {% if section.settings.kicker != blank %}
    <p class="caption-with-letter-spacing">{{ section.settings.kicker }}</p>
  {% endif %}
  {% if section.settings.heading != blank %}
    <h2 class="h1">{{ section.settings.heading }}</h2>
  {% endif %}
  {% if section.settings.subheading != blank %}
    <p class="subtitle">{{ section.settings.subheading }}</p>
  {% endif %}

  {% if handles.size > 0 %}
    <div class="tabs">
      <div class="tabs__list" role="tablist">
        {% for handle in handles %}
          {% assign c = collections[handle] %}
          {% assign label = section.settings["label_" | append: forloop.index] | default: c.title %}
          <button
            class="tabs__tab{% if forloop.first %} is-active{% endif %}"
            type="button"
            data-target="tc-panel-{{ sid }}-{{ forloop.index }}"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
            role="tab"
          >
            {% if section.settings["dot_" | append: forloop.index] %}
              <span class="tabs__dot"></span>
            {% endif %}
            {{ label }}
          </button>
        {% endfor %}
      </div>
    </div>

    <div class="tabs__panels">
      {% for handle in handles %}
        {% assign c = collections[handle] %}
        {% paginate c.products by section.settings.products_per_page %}
          <div
            id="tc-panel-{{ sid }}-{{ forloop.index }}"
            class="tabs__panel{% unless forloop.first %} is-hidden{% endunless %}"
            role="tabpanel"
          >
            <div class="grid grid--2-col-tablet grid--4-col-desktop">
              {% for product in c.products %}
                <div class="grid__item">
                  {% render 'card-product',
                    card_product: product,
                    media_aspect_ratio: section.settings.aspect_ratio,
                    show_secondary_image: true,
                    show_vendor: false,
                    show_rating: false,
                    section_id: sid
                  %}
                </div>
              {% endfor %}
            </div>

            {% if section.settings.show_view_all and c.url %}
              <div class="center">
                <a href="{{ c.url }}" class="button">
                  {{- section.settings.view_all_label | default: 'Ver más productos' -}}
                </a>
              </div>
            {% endif %}
          </div>
        {% endpaginate %}
      {% endfor %}
    </div>
  {% else %}
    <p style="opacity:.7">Add at least one collection in the section settings.</p>
  {% endif %}
</section>

<style>
  #tabbed-collections-{{ sid }} .tabs__list{display:flex;flex-wrap:wrap;gap:.5rem;margin:.5rem 0 1.25rem}
  #tabbed-collections-{{ sid }} .tabs__tab{border:1px solid var(--color-foreground-10, #ddd);border-radius:999px;padding:.4rem .9rem;background:transparent;font:inherit;cursor:pointer}
  #tabbed-collections-{{ sid }} .tabs__tab.is-active{background:#eef4ef;border-color:#2fb673}
  #tabbed-collections-{{ sid }} .tabs__dot{display:inline-block;width:.55rem;height:.55rem;border-radius:50%;background:#2fb673;margin-right:.5rem}
  #tabbed-collections-{{ sid }} .tabs__panel.is-hidden{display:none}
</style>

{% schema %}
{
  "name": "Tabbed collections",
  "settings": [
    { "type": "text", "id": "kicker", "label": "Kicker", "default": "SOLUCIONES." },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Bio-estimulantes" },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Impulsa tus cosechas con biología viva. Bio-estimulantes diseñados para dar fuerza, calidad y productividad a tu tierra."
    },

    { "type": "collection", "id": "collection_1", "label": "Collection 1" },
    { "type": "text", "id": "label_1", "label": "Label 1" },
    { "type": "checkbox", "id": "dot_1", "label": "Show dot 1", "default": true },

    { "type": "collection", "id": "collection_2", "label": "Collection 2" },
    { "type": "text", "id": "label_2", "label": "Label 2" },
    { "type": "checkbox", "id": "dot_2", "label": "Show dot 2", "default": true },

    { "type": "collection", "id": "collection_3", "label": "Collection 3" },
    { "type": "text", "id": "label_3", "label": "Label 3" },
    { "type": "checkbox", "id": "dot_3", "label": "Show dot 3", "default": true },

    { "type": "collection", "id": "collection_4", "label": "Collection 4" },
    { "type": "text", "id": "label_4", "label": "Label 4" },
    { "type": "checkbox", "id": "dot_4", "label": "Show dot 4", "default": true },

    { "type": "collection", "id": "collection_5", "label": "Collection 5" },
    { "type": "text", "id": "label_5", "label": "Label 5" },
    { "type": "checkbox", "id": "dot_5", "label": "Show dot 5", "default": true },

    { "type": "collection", "id": "collection_6", "label": "Collection 6" },
    { "type": "text", "id": "label_6", "label": "Label 6" },
    { "type": "checkbox", "id": "dot_6", "label": "Show dot 6", "default": true },

    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Image ratio",
      "default": "adapt",
      "options": [
        { "value": "adapt", "label": "Adapt to image" },
        { "value": "square", "label": "Square" },
        { "value": "portrait", "label": "Portrait" }
      ]
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per tab",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 8
    },
    { "type": "checkbox", "id": "show_view_all", "label": "Show “View more” button", "default": true },
    { "type": "text", "id": "view_all_label", "label": "Button label", "default": "Ver más productos" }
  ],
  "presets": [{ "name": "Tabbed collections" }]
}
{% endschema %}

<script>
  document.addEventListener('click', function (e) {
    var btn = e.target.closest('#tabbed-collections-{{ sid }} .tabs__tab');
    if (!btn) return;
    var root = document.getElementById('tabbed-collections-{{ sid }}');
    root.querySelectorAll('.tabs__tab').forEach(function (t) {
      t.classList.toggle('is-active', t === btn);
      t.setAttribute('aria-selected', t === btn ? 'true' : 'false');
    });
    root.querySelectorAll('.tabs__panel').forEach(function (p) {
      p.classList.add('is-hidden');
    });
    var panel = root.querySelector('#' + btn.dataset.target);
    if (panel) panel.classList.remove('is-hidden');
  });
</script>
