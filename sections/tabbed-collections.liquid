<section id="tabbed-collections-{{ section.id }}" class="page-width">
  {% if section.settings.kicker != blank %}
    <p class="caption-with-letter-spacing">{{ section.settings.kicker }}</p>
  {% endif %}
  {% if section.settings.heading != blank %}
    <h1 class="h1">{{ section.settings.heading }}</h1>
  {% endif %}
  {% if section.settings.subheading != blank %}
    <p class="subtitle">{{ section.settings.subheading }}</p>
  {% endif %}

  {%- assign has_any = false -%}
  {%- for i in (1..6) -%}
    {%- capture key %}collection_{{ i }}{% endcapture -%}
    {%- assign c = section.settings[key] -%}
    {%- if c != blank -%}{%- assign has_any = true -%}{%- endif -%}
  {%- endfor -%}

  {% if has_any %}
    <div class="tabs">
      <div class="tabs__list" role="tablist">
        {%- assign first_rendered = true -%}
        {%- for i in (1..6) -%}
          {%- capture ckey %}collection_{{ i }}{% endcapture -%}
          {%- capture lkey %}label_{{ i }}{% endcapture -%}
          {%- capture dkey %}dot_{{ i }}{% endcapture -%}
          {%- capture ikey %}icon_{{ i }}{% endcapture -%}
          {%- assign c = section.settings[ckey] -%}
          {%- if c != blank -%}
            {%- assign label = section.settings[lkey] | default: c.title -%}
            {%- assign icon = section.settings[ikey] -%}
            <button
              class="tabs__tab{% if first_rendered %} is-active{% endif %}"
              type="button"
              role="tab"
              aria-selected="{% if first_rendered %}true{% else %}false{% endif %}"
              data-target="tc-panel-{{ section.id }}-{{ i }}"
            >
              {%- if icon != blank -%}
                {{ icon | image_url: width: 28 | image_tag: class: 'tabs__icon-img', alt: '' }}
              {%- elsif section.settings[dkey] -%}
                <span class="tabs__dot"></span>
              {%- endif -%}
              <span class="tabs__label">{{ label }}</span>
            </button>
            {%- assign first_rendered = false -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>

    <div class="tabs__panels">
      {%- assign first_panel = true -%}
      {%- for i in (1..6) -%}
        {%- capture ckey %}collection_{{ i }}{% endcapture -%}
        {%- assign c = section.settings[ckey] -%}
        {%- if c != blank -%}
          <div
            id="tc-panel-{{ section.id }}-{{ i }}"
            class="tabs__panel{% unless first_panel %} is-hidden{% endunless %}"
            role="tabpanel"
          >
            {% liquid
              assign prod_limit = section.settings.products_limit | plus: 0
            %}
            <div class="grid grid--2-col-tablet grid--4-col-desktop">
              {% for product in c.products limit: prod_limit %}
                <div class="grid__item">
                  {% render 'card-product', card_product: product, section_id: section.id, show_excerpt: true %}
                </div>
              {% endfor %}
            </div>

            {% if section.settings.show_view_all and c.url %}
              <div class="center" style="margin-top:2rem;">
                <a href="{{ c.url }}" class="button tc__cta">
                  {{ section.settings.view_all_label | default: 'Ver más productos' }}
                </a>
              </div>
            {% endif %}
          </div>
          {%- assign first_panel = false -%}
        {%- endif -%}
      {%- endfor -%}
    </div>
  {% else %}
    <p style="opacity:.7">Set “Collection 1…6” in the section settings.</p>
  {% endif %}
</section>

<script>
  // Tabs toggle
  document.addEventListener('click', function (e) {
    var root = document.getElementById('tabbed-collections-{{ section.id }}');
    if (!root) return;

    var btn = e.target.closest('#tabbed-collections-{{ section.id }} .tabs__tab');
    if (!btn || !root.contains(btn)) return;

    root.querySelectorAll('.tabs__tab').forEach(function (t) {
      var active = t === btn;
      t.classList.toggle('is-active', active);
      t.setAttribute('aria-selected', active ? 'true' : 'false');
    });

    root.querySelectorAll('.tabs__panel').forEach(function (p) {
      p.classList.add('is-hidden');
    });

    var panelId = btn.getAttribute('data-target');
    if (!panelId) return;
    var panel = root.querySelector('#' + panelId);
    if (panel) panel.classList.remove('is-hidden');
  });

  // Make full card clickable on tablet + mobile
  (function () {
    var root = document.getElementById('tabbed-collections-{{ section.id }}');
    if (!root) return;

    function bindCardClicks() {
      var isTouchSize = window.matchMedia('(max-width: 989.98px)').matches;
      root.querySelectorAll('.product-card-wrapper .card').forEach(function (card) {
        card.style.cursor = isTouchSize ? 'pointer' : '';
        if (card.__tcBound) return;
        card.__tcBound = true;

        card.addEventListener(
          'click',
          function (e) {
            if (e.target.closest('a, button, input, select, textarea')) return;
            if (!window.matchMedia('(max-width: 989.98px)').matches) return;
            var link = card.querySelector('.full-unstyled-link, .card__view-link, a[href]');
            if (link && link.href) window.location.href = link.href;
          },
          { passive: true }
        );
      });
    }

    bindCardClicks();
    window.addEventListener('resize', bindCardClicks);
  })();
</script>

<style>
  /* ====== Tabbed Collections base ====== */
  #tabbed-collections-{{ section.id }}{
    --tc-border: rgba(var(--color-foreground), .25);
    --tc-dot: #2fb673;
    --tc-gap: 12px;
    padding-top: 80px;
    padding-bottom: 80px;
  }
  #tabbed-collections-{{ section.id }} .caption-with-letter-spacing,
  #tabbed-collections-{{ section.id }} .h1,
  #tabbed-collections-{{ section.id }} .subtitle{
    text-align:center; margin-left:auto; margin-right:auto;
  }
  #tabbed-collections-{{ section.id }} .h1{ margin:.5rem 0 0; }
  #tabbed-collections-{{ section.id }} .subtitle{ margin:.5rem 0 2.25rem; opacity:.9; }

  /* Tabs row (grid on ≥ tablet) */
  #tabbed-collections-{{ section.id }} .tabs__list{
    display:grid !important; width:100%; gap:var(--tc-gap); margin:2rem 0 2rem;
    grid-template-columns:repeat(2,minmax(0,1fr));
  }
  @media (min-width:750px){
    #tabbed-collections-{{ section.id }} .tabs__list{ grid-template-columns:repeat(3,minmax(0,1fr)); }
  }
  @media (min-width:990px){
    #tabbed-collections-{{ section.id }} .tabs__list{ grid-template-columns:repeat(6,minmax(0,1fr)); }
  }

  /* Tab pills */
  #tabbed-collections-{{ section.id }} .tabs__tab{
    width:100%; display:inline-flex; align-items:center; justify-content:center; gap:.55rem;
    border:1px solid var(--tc-border); border-radius:4px; background:#f7f3ee;
    padding:.65rem .95rem; line-height:1; cursor:pointer;
    transition:background .15s ease, border-color .15s ease, box-shadow .15s ease;
    color: rgba(var(--color-foreground), 1) !important; /* keep label foreground color */
    -webkit-tap-highlight-color: transparent;
  }
  #tabbed-collections-{{ section.id }} .tabs__tab:is(:hover,:focus,:focus-visible,:active),
  #tabbed-collections-{{ section.id }} .tabs__tab[aria-selected="true"]{
    color: rgba(var(--color-foreground), 1) !important;
  }
  #tabbed-collections-{{ section.id }} .tabs__tab:hover{ background:rgba(var(--color-foreground),.05); }
  #tabbed-collections-{{ section.id }} .tabs__tab.is-active{
    background:#E4E7C3; color:#1F4D37; font-weight: 500;
  }
  #tabbed-collections-{{ section.id }} .tabs__icon-img{ width:18px; height:18px; object-fit:contain; flex:0 0 auto; }
  #tabbed-collections-{{ section.id }} .tabs__label{
    color:inherit !important; text-decoration:none !important; white-space:nowrap; font-size: 12px;
  }
  #tabbed-collections-{{ section.id }} .tabs__dot{ width:.9rem; height:.9rem; border-radius:999px; background:var(--tc-dot); }

  /* Panels */
  #tabbed-collections-{{ section.id }} .tabs__panels{ margin-top:24px; } /* 24px gap between tabs and cards */
  #tabbed-collections-{{ section.id }} .tabs__panel.is-hidden{ display:none !important; }
  #tabbed-collections-{{ section.id }} .grid__item{ margin-bottom:1.25rem; }
  #tabbed-collections-{{ section.id }} .center{ text-align:center; }
  #tabbed-collections-{{ section.id }} .tc__cta{ border-radius:999px; padding:.6rem 1.1rem; }

  /* ====== MOBILE (≤ 749.98px) ====== */
  @media (max-width: 749.98px){
    #tabbed-collections-{{ section.id }}{ padding-top:60px; padding-bottom:60px; } /* mobile spacing */

    /* Make tabs horizontally scrollable */
    #tabbed-collections-{{ section.id }} .tabs__list{
      display:flex !important; flex-wrap:nowrap; overflow-x:auto; overflow-y:hidden;
      -webkit-overflow-scrolling:touch; gap:10px; padding:0 12px; margin:1rem 0 1.25rem;
      scroll-snap-type:x proximity;
    }
    #tabbed-collections-{{ section.id }} .tabs__tab{
      flex:0 0 auto; white-space:nowrap; min-height:40px; scroll-snap-align:start;
    }
    #tabbed-collections-{{ section.id }} .tabs__list::-webkit-scrollbar{ height:0; }

    /* 2-up product grid */
    #tabbed-collections-{{ section.id }} .tabs__panel .grid{
      display:grid !important; grid-template-columns:repeat(2,minmax(0,1fr)); column-gap:24px; row-gap:24px;
    }
    #tabbed-collections-{{ section.id }} .tabs__panel .grid__item{
      width:auto !important; max-width:none !important; margin:0 !important;
    }

    /* Mobile image fill (Safari/Chrome proof) */
    #tabbed-collections-{{ section.id }} .card__inner.ratio{
      position:relative !important; aspect-ratio:1/1 !important; overflow:hidden !important;
    }
    #tabbed-collections-{{ section.id }} .card__inner.ratio::before{ display:none !important; }
    #tabbed-collections-{{ section.id }} .card__inner.ratio > .card__media,
    #tabbed-collections-{{ section.id }} .card__inner.ratio > .card__media > .media{
      position:absolute !important; inset:0 !important; width:100% !important; height:100% !important;
      contain:paint; -webkit-backface-visibility:hidden;
    }
    #tabbed-collections-{{ section.id }} .card__inner.ratio .media > img{
      position:absolute !important; inset:0 !important; display:block !important;
      width:100% !important; height:100% !important; max-width:none !important; max-height:none !important;
      object-fit:cover !important; object-position:center !important;
      transform:none !important; -webkit-transform:translateZ(0);
      backface-visibility:hidden; -webkit-backface-visibility:hidden;
    }
    #tabbed-collections-{{ section.id }} .media.media--hover-effect > img{ transform:none !important; }
  }

  /* ====== DESKTOP label overflow fix (≥ 990px) ====== */
  @media (min-width: 990px){
    #tabbed-collections-{{ section.id }} .tabs__list{
      grid-template-columns: repeat(6, minmax(0, 1fr)) !important;
    }
    #tabbed-collections-{{ section.id }} .tabs__tab{
      min-width:0; box-sizing:border-box; overflow:hidden; white-space:normal; text-align:center;
    }
    #tabbed-collections-{{ section.id }} .tabs__label{
      display:block; min-width:0; max-width:100%; white-space:normal !important;
      overflow-wrap:anywhere; word-break:break-word; line-height:1.15;
    }
    #tabbed-collections-{{ section.id }} .tabs__icon-img{ flex:0 0 auto; }
  }
</style>

{% schema %}
{
  "name": "Tabbed collections",
  "settings": [
    { "type": "text", "id": "kicker", "label": "Kicker" },
    { "type": "text", "id": "heading", "label": "Heading" },
    { "type": "text", "id": "subheading", "label": "Subheading" },
    { "type": "checkbox", "id": "show_card_excerpt", "label": "Show product description", "default": true },

    { "type": "collection", "id": "collection_1", "label": "Collection 1" },
    { "type": "text", "id": "label_1", "label": "Label 1" },
    { "type": "checkbox", "id": "dot_1", "label": "Show dot 1", "default": true },
    { "type": "image_picker", "id": "icon_1", "label": "Icon 1 (SVG/PNG)" },

    { "type": "collection", "id": "collection_2", "label": "Collection 2" },
    { "type": "text", "id": "label_2", "label": "Label 2" },
    { "type": "checkbox", "id": "dot_2", "label": "Show dot 2", "default": true },
    { "type": "image_picker", "id": "icon_2", "label": "Icon 2 (SVG/PNG)" },

    { "type": "collection", "id": "collection_3", "label": "Collection 3" },
    { "type": "text", "id": "label_3", "label": "Label 3" },
    { "type": "checkbox", "id": "dot_3", "label": "Show dot 3", "default": true },
    { "type": "image_picker", "id": "icon_3", "label": "Icon 3 (SVG/PNG)" },

    { "type": "collection", "id": "collection_4", "label": "Collection 4" },
    { "type": "text", "id": "label_4", "label": "Label 4" },
    { "type": "checkbox", "id": "dot_4", "label": "Show dot 4", "default": true },
    { "type": "image_picker", "id": "icon_4", "label": "Icon 4 (SVG/PNG)" },

    { "type": "collection", "id": "collection_5", "label": "Collection 5" },
    { "type": "text", "id": "label_5", "label": "Label 5" },
    { "type": "checkbox", "id": "dot_5", "label": "Show dot 5", "default": true },
    { "type": "image_picker", "id": "icon_5", "label": "Icon 5 (SVG/PNG)" },

    { "type": "collection", "id": "collection_6", "label": "Collection 6" },
    { "type": "text", "id": "label_6", "label": "Label 6" },
    { "type": "checkbox", "id": "dot_6", "label": "Show dot 6", "default": true },
    { "type": "image_picker", "id": "icon_6", "label": "Icon 6 (SVG/PNG)" },

    {
      "type": "select",
      "id": "products_limit",
      "label": "Products per tab",
      "default": "4",
      "options": [
        { "label": "4", "value": "4" },
        { "label": "8", "value": "8" },
        { "label": "12", "value": "12" }
      ]
    },
    { "type": "checkbox", "id": "show_view_all", "label": "Show “View more” button", "default": true },
    { "type": "text", "id": "view_all_label", "label": "Button label", "default": "Ver más productos" }
  ],
  "presets": [{ "name": "Tabbed collections" }]
}
{% endschema %}
