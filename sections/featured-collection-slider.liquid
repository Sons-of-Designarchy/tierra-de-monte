{% liquid
  assign section_id = section.id
  assign first_block = section.blocks.first
%}
<section id="tabbed-collections-{{ section_id }}" class="page-width">
  {% if section.settings.kicker != blank %}
    <p class="caption-with-letter-spacing">{{ section.settings.kicker }}</p>
  {% endif %}
  {% if section.settings.heading != blank %}
    <h2 class="h1">{{ section.settings.heading }}</h2>
  {% endif %}
  {% if section.settings.subheading != blank %}
    <p class="subtitle">{{ section.settings.subheading }}</p>
  {% endif %}

  <div class="tabs">
    <div class="tabs__list" role="tablist">
      {% for block in section.blocks %}
        {% assign b = block.settings %}
        <button
          class="tabs__tab{% if forloop.first %} is-active{% endif %}"
          role="tab"
          aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
          aria-controls="tc-panel-{{ section_id }}-{{ forloop.index }}"
          data-target="tc-panel-{{ section_id }}-{{ forloop.index }}"
        >
          {% if b.dot %}<span class="tabs__dot"></span>{% endif %}
          {{ b.title | default: b.collection.title }}
        </button>
      {% endfor %}
    </div>
  </div>

  <div class="tabs__panels">
    {% for block in section.blocks %}
      {% assign b = block.settings %}
      {% if b.collection != blank %}
        {% paginate b.collection.products by section.settings.products_per_page %}
          <div
            id="tc-panel-{{ section_id }}-{{ forloop.index }}"
            class="tabs__panel{% unless forloop.first %} is-hidden{% endunless %}"
            role="tabpanel"
          >
            <div class="grid grid--2-col-tablet grid--4-col-desktop">
              {% for product in b.collection.products %}
                <div class="grid__item">
                  {% render 'card-product',
                    card_product: product,
                    media_aspect_ratio: section.settings.aspect_ratio,
                    show_secondary_image: true,
                    show_vendor: false,
                    show_rating: false,
                    section_id: section_id
                  %}
                </div>
              {% endfor %}
            </div>

            {% if section.settings.show_view_all and b.collection.url %}
              <div class="center">
                <a href="{{ b.collection.url }}" class="button">
                  {{ section.settings.view_all_label | default: 'Ver más productos' }}
                </a>
              </div>
            {% endif %}
          </div>
        {% endpaginate %}
      {% endif %}
    {% endfor %}
  </div>

  <style>
    #tabbed-collections-{{ section_id }} .tabs__list{display:flex;flex-wrap:wrap;gap:.5rem;margin:.5rem 0 1.25rem}
    #tabbed-collections-{{ section_id }} .tabs__tab{border:1px solid var(--color-foreground-10);border-radius:999px;padding:.4rem .9rem;background:transparent;font:inherit;cursor:pointer}
    #tabbed-collections-{{ section_id }} .tabs__tab.is-active{background:var(--color-background);border-color:var(--color-foreground)}
    #tabbed-collections-{{ section_id }} .tabs__dot{display:inline-block;width:.55rem;height:.55rem;border-radius:50%;background:currentColor;margin-right:.5rem}
    #tabbed-collections-{{ section_id }} .tabs__panel.is-hidden{display:none}
  </style>
</section>

{% schema %}
{
  "name": "Tabbed collections",
  "settings": [
    { "type": "text", "id": "kicker", "label": "Kicker" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Bio-estimulantes" },
    { "type": "text", "id": "subheading", "label": "Subheading" },
    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Image ratio",
      "default": "square",
      "options": [
        { "value": "adapt", "label": "Adapt to image" },
        { "value": "square", "label": "Square" },
        { "value": "portrait", "label": "Portrait" }
      ]
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per tab",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 8
    },
    { "type": "checkbox", "id": "show_view_all", "label": "Show “View more” button", "default": true },
    { "type": "text", "id": "view_all_label", "label": "Button label", "default": "Ver más productos" }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "settings": [
        { "type": "collection", "id": "collection", "label": "Collection" },
        { "type": "text", "id": "title", "label": "Tab label" },
        { "type": "checkbox", "id": "dot", "label": "Show status dot", "default": true }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Tabbed collections",
      "blocks": [{ "type": "collection" }, { "type": "collection" }, { "type": "collection" }]
    }
  ]
}
{% endschema %}

{% stylesheet %}{% endstylesheet %}
{% javascript %}
  document.addEventListener('click', (e) => {
    const b = e.target.closest('.tabs__tab');
    if (!b) return;
    const root = b.closest('section');
    root.querySelectorAll('.tabs__tab').forEach((t) => {
      t.classList.toggle('is-active', t === b);
      t.setAttribute('aria-selected', t === b ? 'true' : 'false');
    });
    const id = b.dataset.target;
    root.querySelectorAll('.tabs__panel').forEach((p) => p.classList.add('is-hidden'));
    const panel = root.querySelector('#' + id);
    if (panel) panel.classList.remove('is-hidden');
  });
{% endjavascript %}
